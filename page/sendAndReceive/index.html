<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SFT Wallet</title>
  <link rel="stylesheet" href="./css/index.css">
  <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/gh/jquery-i18n-properties/jquery-i18n-properties/jquery.i18n.properties.min.js"></script>

</head>

<style type="text/css">
.qrcode_img {
    margin: 0 auto;
    border:3px solid #f6f6f6;
}
#myqrcode {
    width: 100%;
    margin-top:15px;
    text-align: center;
    justify-content: center;
    display: flex !important;
}	
</style>

<body>
  <div class="header">
    <div class="headerLeft">
      <div class="logoBox">
        <img src="../../assets/walletIndex/logo.svg" alt="logo">
      </div>
      <div class="selectBox">
        <a href="../balance/index.html">
          <div class="selectBoxCell currSelect">
            <img src="../../assets/balance/wallet.svg" alt="">
            <p>Wallet</p>
          </div>
        </a>

        <a href="../account/index.html">
          <div class="selectBoxCell">
            <img src="../../assets/balance/accountNot.svg" alt="">
            <p>Account</p>
          </div>
        </a>
      </div>
    </div>
    <div class="languageBox">
      <div class="addressBox">
        <img class="addressIcon" src="../../assets/balance/address.svg" alt="address">
        <p id="lab_addr_1">...</p>
        <img class="arrowIcon" src="../../assets/balance/arrow.svg" alt="arrow" >
      </div>
      <div class="custom-select">
        <div class="select-selected">
          <img src="../../assets/walletIndex/Language.svg" alt="arrow">
          <p>Language</p>
          <img src="../../assets/walletIndex/arrow.svg" alt="arrow">
        </div>
        <div class="select-items" style="display: none;">
          <div data-value="en">English</div>
          <div data-value="zh">中文</div>
        </div>
      </div>
      

    </div>
  </div>
  <div class="accountPop" style="display: none">
    <p class="accountPopTitle" data-lang="Account">
      Account
    </p>
    <div class="accountInfoBox">
      <div class="accountInfoBoxLeft">
        <p id="lab_addr_2">...</p>
        <span id="lab_balance_1">0 SPD</span>
      </div>
      <div class="copyBtn" onclick="javascript:window.copyAddr();">
        <img src="../../assets/balance/copy.svg" alt="copy">
      </div>
      <div class="viewBtn">
        <img src="../../assets/balance/view.svg" alt="view">
      </div>
    </div>
    <a href="../importAccount/index.html">
      <button class="importAccountBtn">
        <img src="../../assets/balance/import.svg" alt="import">
        <p data-lang="importAccount">Import Account</p>
      </button>
    </a>
    <a href="../createAccount/index.html">
      <button class="createNewAccountBtn">
        <img src="../../assets/balance/create.svg" alt="import">
        <p data-lang="createNewAccount">Create New Account</p>
      </button>
    </a>
  </div>
  <div class="content">
    <div class="balanceBox">
      <div class="tabContainer">
        <div class="tabButtons">
          <button class="tabButton active" dataTab="send" data-lang="send">Send</button>
          <button class="tabButton" dataTab="receive" data-lang="receive">Receive</button>
        </div>
        <div class="tabContent">
          <div class="tabItem active" id="send">
            <div class="tabBox">
              <div class="iptBox">
                <input type="text">
              </div>
              <button class="useMaxBtn" onclick="javascript:window.clickMax();">
                <p data-lang="useMax">Use Max</p>
              </button> 
              <div class="assetsSelect">
                <div class="selectHeader">
                  <p class="selectedAsset">Select Asset</p>
                  <div class="currChoose">
                    <img src="../../assets/balance/spdToken.svg" alt="spdToken">
                    <p>SFT</p>
                  </div>
                </div>
                <div class="selectOptions">
                  <div class="option" data-value="SPD">
                    <img src="../../assets/balance/spdToken.svg" alt="spdToken">
                    <p>SFT</p>
                  </div>
                  <!-- <div class="option" data-value="rSpd">
                    <img src="../../assets/balance/spdToken.svg" alt="rSpd">
                    <p>rSPD</p> 
                  </div> -->
                </div>
              </div>
              <div class="availableToSend">
                <p class="availableToSendTitle" data-lang="availableToSend">
                  Available to Send
                </p>
                <p id="lab_balance_2">
                  0 SFT
                </p>
              </div>
              <div class="availableToSend">
                <p class="availableToSendTitle" data-lang="receiverToSend">
                  Receiver
                </p>
                <input id="input_to" placeholder="receiver">
              </div>
              <div class="availableToSend">
                <p class="availableToSendTitle" data-lang="amountToSend">
                  Amount
                </p>
                <input id="input_value" placeholder="amount">
              </div>
              <div class="btnBox">
                <button class="continueBtn" onclick="javascript:window.sendTx();">
                  <p data-lang="continue">Continue</p>
                </button>
              <a href="../balance/index.html">
                <button class="cancelBtn">
                  <p data-lang="cancel">Cancel</p>
                </button>
              </a>
              </div>
              
              
            </div>
       
          </div>
          <div class="tabItem" id="receive">
            <div class="receiveBox">
              <div class="QRCodeBox" id="myqrcode">
                <!-- <img src="../../assets/send/QRCode.svg" alt="" srcset=""> -->
              </div>
              <div class="walletAddress">
                <p class="availableToSendTitle" data-lang="availableToSend">
                  Available to Send
                </p>
                <div class="addressBox">
                  <p id="lab_addr_3">
                    ...
                  </p>
                  <img src="../../assets/balance/copy.svg" alt="" srcset="" onclick="javascript:window.copyAddr();">
                </div>
              </div>
              <div class="availableToSend">
                <p class="availableToSendTitle" data-lang="availableToSend">
                  Available to Send
                </p>
                <p id="lab_balance_3">
                  0 SFT
                </p>
              </div>
            </div>
           
          </div>
        </div>
      </div>

    
    </div>
  </div>
  </div>
  <script src="../../assets/js/init.js"></script>
  <script src="./js/index.js"></script>
	<script src="../../core/axios.min.js"></script>
	<script src="../../core/babel-browser.min.js"></script>
	<script src="../../core/bitcore-mnemonic.js"></script>
	<script src="../../core/qrcode.min.js"></script>
	<script src="../../core/bignumber.js"></script>
	<script src="../../core/lang/ch.js"></script>
	<script src="../../core/lang/en.js"></script>
	<script src="../../core/core.js"></script>
	<script src="../../core/Base58.js"></script>

	<script type="text/javascript">
		var gasPrice = 2;
		var gasLimit = 80000;

		var bal_sft = "0";

		window.load = function(addr) {
			var mne = getAddrMnemonic(addr);

			var wallet = Yoethwallet.wallet;
			var priv;

			var bip39 = Yoethwallet.wallet.bip39();
			var HDKey = Yoethwallet.wallet.HDKey();

			if(!bip39.validateMnemonic(mne)) {
				showToast('failure', "invalid mnemonics");
				return;
			}

			var selectedPath = "m/44\'/60\'/0\'/0/0";
			var key = HDKey.fromMasterSeed(bip39.mnemonicToSeed(mne));
			priv = key.derive(selectedPath).privateKey;

			wallet.fromPrivateKey(priv, function(err, keystore) {
				if (err) {
					// alert(err);
					showToast("failure", err);
					return;
				}

				var chain = getCreatedChain();
				if(chain == null) {
					chain = "SFT";
				}

				System.chain = chain;

				System.Priv = keystore.getPrivateKey();
			});
		}

		window.onload = function() {
			changeLang();

			var chain = getCreatedChain();
			if(chain == null) {
				chain = "SFT";
			}
			System.chain = chain;

			var curr = getCurrent();

			document.getElementById("lab_addr_1").innerHTML = lessAddr(curr.addr, 12);
			document.getElementById("lab_addr_2").innerHTML = lessAddr(curr.addr, 12);
			document.getElementById("lab_addr_3").innerHTML = lessAddr(curr.addr, 12);
			
			rpc_getBalance(curr.addr, function(data_bal) {
				var x = new BigNumber(data_bal);
				x /= 1e18;
				document.getElementById("lab_balance_1").innerHTML = x.toFixed(4) + " SFT";
				document.getElementById("lab_balance_2").innerHTML = x.toFixed(4) + " SFT";
				document.getElementById("lab_balance_3").innerHTML = x.toFixed(4) + " SFT";

				bal_sft = x.toFixed(4);
			}, function(err_bal) {

			})

			System.addr = curr.addr;

			window.load(curr.addr);

			var mycode = new QRCode(document.getElementById("myqrcode"), {
				width: 350,
				height: 350
			});
			mycode.makeCode(curr.addr);
			$("#myqrcode img").addClass("qrcode_img");
		}


		window.sendTx = function () {
			var from = System.addr;
			var to = document.getElementById('input_to').value;
			var amount = document.getElementById('input_value').value;

			if (!is_eth_addr(to)) {
				showToast("failure", "invalid receiver address");
				return;
			}

			if (!is_number(amount)) {
				showToast("failure", "invalid amount");
				return;
			}

			if(amount > bal_sft) {
				showToast("failure", "insufficient balance");
				return;
			}

			var na = convertToAmount(amount, true, 18);
			var np = convertToGasPrice(gasPrice, true);
			var nl = convertBigNumber(gasLimit, true);

			rpc_getTransactionCount(System.addr, function (data_c) {
				var tx = Yoethwallet.tx;

				var signedTransaction = "";

				var valueTx = tx.valueTx({
					from: from,
					to: to,
					value: na,
					nonce: data_c,
					gas: nl,
					gasPrice: np,
					chainId: get_chainID()
				});
				valueTx.sign(System.Priv);
				signedTransaction = '0x' + valueTx.serialize().toString('hex');
				
				
				rpc_sendRawTransaction(signedTransaction, function (data_tx) {
					showToast("success", "successfully");

					document.getElementById('input_value').value = "";

					// setTimeout(function() {
					// 	clearTxParamTo();

					// 	window.location.href = ".html";
					// }, 3000);

				}, function (err) {
					toast(err);
				});
			}, function (err) {
				toast(lan.ALERT_NET_ERR);
			})
		}

		window.clickMax = function() {
			if(bal_sft > 0.0001) {
				document.getElementById("input_value").value = bal_sft - 0.0001;
			}
		}

		window.copyAddr = function() {
			var curr = getCurrent();
			var oInput = document.createElement('input');
            oInput.value = curr.addr;
            document.body.appendChild(oInput);
            oInput.select(); // 选择对象
            document.execCommand("Copy"); // 执行浏览器复制命令
            oInput.className = 'oInput';
            oInput.style.display='none';
            showToast("success", "Copied");
		}
	</script>

</body>

</html>